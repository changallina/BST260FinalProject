---
title: "BST260WHR project"
author: "Sung-An Tai"
date: "2020/11/27"
output: html_document
---
```{r}
library(tidyverse)
library(readxl) 
library(gsheet)
library(MASS)

# Read WHR20_DataForFigure2.1.xls (2017~2019 average) and WHR20_DataForTable2.1.xls (2008~2019 with additional variables)
# Main dependent variable: Ladder score, independent variable: `Logged GDP per capita`+`Social support`+`Healthy life expectancy`+`Freedom to make life choices`+`Generosity`+`Perceptions of corruption`
whr20 <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1jVOpMfl94xDmip0NrJEXORoFK4RBfB7leDVzyJnk47w/edit#gid=28299357", sheetid = NULL)
whr_all <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1oMzplKOmjs0hKKmXKqOCM90CvPsS7aCIj1adox0nvNU/edit#gid=1261774380", sheetid = NULL)
names(whr20)

# Main model for fig 2.1 in the WHR 2020 report, but they used pooled OLS regression specific for panel analysis, rather than plain multiple regression
mod1 <- lm(`Ladder score` ~ `Logged GDP per capita`+
             `Social support`+`Healthy life expectancy`+
             `Freedom to make life choices`+
             `Generosity`+
             `Perceptions of corruption`,
           data = whr20)
summary(mod1)

# Model for 2019 only
whr19 <- whr_all %>% filter(year == 2019)
mod_19 <- lm(`Life Ladder` ~ `Log GDP per capita`+
             `Social support`+`Healthy life expectancy at birth`+
             `Freedom to make life choices`+
             `Generosity`+
             `Perceptions of corruption`,
           data = whr19)

summary(mod_19)

# Model from 2015 to 2019
modeling <- function(y){
  whr_df <- whr_all %>% filter(year == y) %>% dplyr::select(`Life Ladder`, `Log GDP per capita`,
             `Social support`, `Healthy life expectancy at birth`,
             `Freedom to make life choices`,
             `Generosity`,
             `Perceptions of corruption`) %>% drop_na()
  
  mod <- lm(`Life Ladder` ~ `Log GDP per capita`+
             `Social support`+`Healthy life expectancy at birth`+
             `Freedom to make life choices`+
             `Generosity`+
             `Perceptions of corruption`,
           data = whr_df)
  mod
}
years <- 2015:2019
mods.15to19 <- lapply(years, modeling)
names(mods.15to19) <- paste0("mod.", 2015:2019)
lapply(mods.15to19, summary)
lapply(mods.15to19, confint)

```
Should add analysis for effect modification.

Model backward selection:
```{r}
# backward selection for 2017~2019 model and 2019 model
mod1_bkwd <- step(mod1, direction = "backward")
summary(mod1_bkwd)

no.na.whr19 <- whr19 %>% dplyr::select(`Life Ladder`, `Log GDP per capita`,
             `Social support`, `Healthy life expectancy at birth`,
             `Freedom to make life choices`,
             `Generosity`,
             `Perceptions of corruption`) %>% drop_na()
mod_19_noNA <- lm(`Life Ladder` ~ `Log GDP per capita`+
             `Social support`+`Healthy life expectancy at birth`+
             `Freedom to make life choices`+
             `Generosity`+
             `Perceptions of corruption`,
           data = no.na.whr19)
mod_19_bckwd <- step(mod_19_noNA, direction = "backward")
s_19 <- summary(mod_19_bckwd)

# backward selection from 2015 to 2019
backward.select <- function(y){
  whr_df <- whr_all %>% filter(year == y) %>% dplyr::select(`Life Ladder`, `Log GDP per capita`,
             `Social support`, `Healthy life expectancy at birth`,
             `Freedom to make life choices`,
             `Generosity`,
             `Perceptions of corruption`) %>% drop_na()
  
  mod <- lm(`Life Ladder` ~ `Log GDP per capita`+
             `Social support`+`Healthy life expectancy at birth`+
             `Freedom to make life choices`+
             `Generosity`+
             `Perceptions of corruption`,
           data = whr_df)
  mod.backward <- step(mod, direction = "backward")
  mod.backward
}

backward.select(2015)
backward.select(2016)
```
##visualize cantril ladder by year
```{r}
# Happiness by year of all countries
whr_all %>% ggplot(aes(x = year, y = `Life Ladder`, color = `Country name`)) +
                geom_line() +
                ylab("Cantril Ladder") +
                ggtitle("Happiness") +
                scale_color_discrete(name = "Country") +
                theme(axis.text.x = element_text(angle = 70, hjust =1), legend.position = "none") +
                scale_x_continuous(breaks = seq(2005, 2019, by = 1)) +
                xlab("Year")

# Categorize by GDP, divide into 4 parts
whr_gdp <- whr_all %>% filter(!is.na(`Log GDP per capita`))
q_gdp <- whr_gdp %>% summarise(q1 = quantile(`Log GDP per capita`)[2], q3 = quantile(`Log GDP per capita`)[4], mean = mean(`Log GDP per capita`))
quantile(whr_gdp$`Log GDP per capita`)
whr_gdp <- whr_gdp %>% mutate(gdp_cat = cut(`Log GDP per capita`, breaks = c(-Inf, q_gdp[1], q_gdp[3], q_gdp[2], Inf), labels=c(0,1,2,3)))

# We find that full regression model often have insignificant coefficient of Generosity. We tried to stratify according
whr_gdp %>% filter(gdp_cat == 0) %>% ggplot(aes(x = year, y = `Life Ladder`, color = `Country name`)) + geom_line() + theme(legend.position = "none")

whr_gdp %>% filter(gdp_cat==3, year == 2018) %>% ggplot(aes(x = `Generosity`, y = `Life Ladder`)) + geom_point(color = "blue")
mod_gdp3_2018<- lm(`Life Ladder` ~ `Log GDP per capita`+
             `Social support`+`Healthy life expectancy at birth`+
             `Freedom to make life choices`+
             `Generosity`+
             `Perceptions of corruption`, data = whr_gdp %>% filter(gdp_cat==3, year == 2018))
summary(mod_gdp3_2018)
```


